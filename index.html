<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏£‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏• v38 - Equal Shift Distribution</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.294.0",
            "xlsx": "https://cdn.sheetjs.com/xlsx-0.20.1/package/xlsx.mjs"
        }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { 
            font-family: 'Sarabun', sans-serif; 
            margin: 0;
            padding: 0;
            background-color: #f8fafc;
        }
        
        .overflow-x-auto::-webkit-scrollbar { height: 12px; }
        .overflow-x-auto::-webkit-scrollbar-track { background: #f1f5f9; }
        .overflow-x-auto::-webkit-scrollbar-thumb { 
            background: #cbd5e1; 
            border-radius: 6px; 
            border: 2px solid #f1f5f9; 
        }
        .overflow-x-auto::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        table { 
            border-spacing: 0;
            width: 100%;
            border-collapse: separate; /* Fix for sticky borders */
        }
        
        th, td {
            white-space: nowrap;
            text-align: center;
            border: 1px solid #e2e8f0;
            height: 32px;
            padding: 0 4px;
            font-size: 13px;
            box-sizing: border-box;
        }

        /* Sticky Columns Left */
        .sticky-1 { 
            position: sticky; 
            left: 0; 
            width: 40px; 
            min-width: 40px; 
            background-color: white; 
            z-index: 35; 
            border-right: 1px solid #e2e8f0;
        }
        
        .sticky-2 { 
            position: sticky; 
            left: 40px; 
            width: 160px; 
            min-width: 160px; 
            background-color: white; 
            z-index: 35; 
            border-right: 1px solid #e2e8f0;
        }
        
        .sticky-3 { 
            position: sticky; 
            left: 200px; 
            width: 70px; 
            min-width: 70px; 
            background-color: white; 
            border-right: 3px solid #cbd5e1; 
            box-shadow: 4px 0 6px -2px rgba(0, 0, 0, 0.1); 
            z-index: 35; 
        }
        
        thead tr th { 
            position: sticky; 
            top: 0; 
            z-index: 40; 
            background-color: #f1f5f9; 
            color: #334155;
            height: 50px;
        }
        
        thead tr th.sticky-1, 
        thead tr th.sticky-2, 
        thead tr th.sticky-3 { 
            z-index: 50; 
            background-color: #f8fafc;
        }

        .cell-hover:hover { 
            filter: brightness(0.95); 
            cursor: pointer; 
            transform: scale(1.1);
            transition: transform 0.1s;
            z-index: 10;
            position: relative;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }
        
        .header-hover:hover { 
            background-color: #e2e8f0; 
            cursor: pointer; 
        }

        /* Loading Spinner */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #0ea5e9;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @media print {
            .no-print { display: none !important; }
            table { font-size: 10px; width: 100%; }
            th, td { height: 20px; padding: 0; border: 1px solid #000; }
            .sticky-1, .sticky-2, .sticky-3 { position: static; border-right: 1px solid #000; box-shadow: none; width: auto; min-width: auto; }
            body { background-color: white; }
            .overflow-x-auto { overflow: visible; }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Download, Calculator, UserPlus, Trash2, ChevronLeft, ChevronRight, Zap, Eraser, Settings, Edit2, Save, X, Info, BarChart3, AlertCircle } from 'lucide-react';
        import * as XLSX from 'xlsx';

        // --- CONSTANTS ---
        const RATES = { 
            ot: 800,        // ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏ß‡∏£‡πÇ‡∏≠‡∏ó‡∏µ (‡πÅ‡∏ñ‡∏ß‡∏ö‡∏ô)
            shift_bd: 360   // ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ñ‡πà‡∏≤‡πÄ‡∏ß‡∏£ ‡∏ö‡πà‡∏≤‡∏¢/‡∏î‡∏∂‡∏Å (‡πÅ‡∏ñ‡∏ß‡∏•‡πà‡∏≤‡∏á)
        };

        const SHIFT_TYPES = {
            '0':      { label: '0',      color: 'bg-white text-gray-300' },
            '‡∏ä':      { label: '‡∏ä',      color: 'bg-green-100 text-green-800 font-bold' },
            '‡∏ö':      { label: '‡∏ö',      color: 'bg-yellow-100 text-yellow-800 font-bold' },
            '‡∏î':      { label: '‡∏î',      color: 'bg-purple-100 text-purple-800 font-bold' },
            'Va':     { label: 'Va',     color: 'bg-blue-100 text-blue-800 font-bold text-xs' },
            '‡∏õ‡∏ä':     { label: '‡∏õ‡∏ä',     color: 'bg-orange-100 text-orange-800 font-bold text-xs' },
            '‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢': { label: '‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢', color: 'bg-red-100 text-red-800 font-bold text-[10px]' },
            '‡∏•‡∏≤‡∏Å‡∏¥‡∏à':  { label: '‡∏•‡∏≤‡∏Å‡∏¥‡∏à',  color: 'bg-indigo-100 text-indigo-800 font-bold text-[10px]' }
        };
        
        const NON_WORKING_CODES = ['Va', '‡∏õ‡∏ä', '‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢', '‡∏•‡∏≤‡∏Å‡∏¥‡∏à'];
        const CYCLE_TOP = ['0', '‡∏ä', '‡∏ö', '‡∏î']; 
        const CYCLE_BOTTOM = ['0', '‡∏ä', '‡∏ö', '‡∏î', ...NON_WORKING_CODES];

        const INITIAL_NURSES = [
            { id: 1, name: "‡∏ô‡∏≤‡∏á‡∏™‡∏á‡∏ö ‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå‡∏ò‡∏£‡∏£‡∏°", pos: "‡∏´‡∏ô‡∏ï." },
            { id: 2, name: "‡∏ô‡∏≤‡∏¢‡∏ß‡∏¥‡∏©‡∏ì‡∏∏‡∏Å‡∏£‡∏ì‡πå ‡πÇ‡∏¢‡∏¢‡∏≤", pos: "L5" },
            { id: 3, name: "‡∏ô.‡∏™.‡∏à‡∏≤‡∏£‡∏∏‡∏û‡∏£ ‡∏®‡∏£‡∏µ‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥", pos: "L5" },
            { id: 4, name: "‡∏ô.‡∏™.‡πÄ‡∏Ç‡∏°‡∏£‡∏∏‡∏à‡∏¥ ‡∏¢‡∏≤‡∏™‡∏π‡πà", pos: "L4" },
            { id: 5, name: "‡∏ô.‡∏™.‡∏õ‡∏≤‡∏à‡∏≤‡∏£‡∏µ‡∏¢‡πå ‡∏ô‡∏¥‡∏û‡∏±‡∏ô‡∏ò‡πå", pos: "L4" },
            { id: 6, name: "‡∏ô.‡∏™.‡∏™‡∏∏‡∏ô‡∏¥‡∏™‡∏≤ ‡∏™‡∏∏‡∏Ç‡πÄ‡∏≠‡∏¥‡∏ö", pos: "L4" },
            { id: 7, name: "‡∏ô.‡∏™.‡∏™‡∏∏‡∏†‡∏≤‡∏ß‡∏î‡∏µ ‡∏¢‡∏°‡∏ô‡πâ‡∏≠‡∏¢", pos: "L2" },
            { id: 8, name: "‡∏ô.‡∏™.‡∏ó‡∏¥‡∏û‡∏õ‡∏†‡∏≤ ‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏ò‡∏µ", pos: "L2" },
            { id: 9, name: "‡∏ô.‡∏™.‡∏™‡∏∏‡∏ô‡∏±‡∏ô‡∏ó‡∏£‡∏≤ ‡πÄ‡∏Å‡∏ï‡∏∏‡∏û‡∏á‡∏©‡πå", pos: "L1" },
            { id: 10, name: "‡∏ô.‡∏™.‡∏™‡∏¥‡∏£‡∏¥‡∏£‡∏±‡∏ï‡∏ô‡πå ‡∏ö‡∏±‡∏ß‡∏õ‡∏£‡∏∞‡πÄ‡∏™‡∏£‡∏¥‡∏ê", pos: "L1" }
        ];

        export default function RosterApp() {
            const [currentDate, setCurrentDate] = useState(new Date());
            const [nurses, setNurses] = useState(INITIAL_NURSES);
            const [schedule, setSchedule] = useState({});
            const [customHolidays, setCustomHolidays] = useState([]);
            const [workDayLimit, setWorkDayLimit] = useState(20);
            const [showModal, setShowModal] = useState(false);
            const [newNurse, setNewNurse] = useState({ name: '', pos: 'L1' });
            const [customConditions, setCustomConditions] = useState('');
            const [editingNurse, setEditingNurse] = useState(null);
            const [isGenerating, setIsGenerating] = useState(false);

            // --- LOCAL STORAGE ---
            useEffect(() => {
                const savedData = localStorage.getItem('roster_data_v38');
                const savedNurses = localStorage.getItem('roster_nurses_v38');
                const savedHolidays = localStorage.getItem('roster_holidays_v38');
                const savedLimit = localStorage.getItem('roster_limit_v38');
                const savedConditions = localStorage.getItem('roster_conditions_v38');
                
                if (savedData) setSchedule(JSON.parse(savedData));
                if (savedNurses) setNurses(JSON.parse(savedNurses));
                if (savedHolidays) setCustomHolidays(JSON.parse(savedHolidays));
                if (savedLimit) setWorkDayLimit(Number(savedLimit));
                if (savedConditions) setCustomConditions(savedConditions);
            }, []);

            const saveAll = (updatedNurses, updatedSchedule, updatedHolidays, updatedLimit, updatedConditions) => {
                if(updatedNurses) {
                    setNurses(updatedNurses);
                    localStorage.setItem('roster_nurses_v38', JSON.stringify(updatedNurses));
                }
                if(updatedSchedule) {
                    setSchedule(updatedSchedule);
                    localStorage.setItem('roster_data_v38', JSON.stringify(updatedSchedule));
                }
                if(updatedHolidays) {
                    setCustomHolidays(updatedHolidays);
                    localStorage.setItem('roster_holidays_v38', JSON.stringify(updatedHolidays));
                }
                if(updatedLimit !== undefined) {
                    setWorkDayLimit(updatedLimit);
                    localStorage.setItem('roster_limit_v38', updatedLimit);
                }
                if(updatedConditions !== undefined) {
                    setCustomConditions(updatedConditions);
                    localStorage.setItem('roster_conditions_v38', updatedConditions);
                }
            };

            // --- HELPERS ---
            const getDaysInMonth = () => new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();
            const getKey = (id, row, day) => `${id}-${row}-${day}`;
            const isHN = (n) => n.pos && n.pos.includes('‡∏´‡∏ô‡∏ï');
            
            const isHoliday = (day) => {
                const d = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
                return [0, 6].includes(d.getDay()) || customHolidays.includes(day);
            };

            // --- CALCULATION LOGIC ---
            const countStats = (nurseId) => {
                const days = getDaysInMonth();
                let otCount = 0;        // Count from Row 0 (Top)
                let bdCount = 0;        // Count '‡∏ö', '‡∏î' from Row 1
                let workDays = 0;       // Count all valid shifts from Row 1
                
                for(let d=1; d<=days; d++) {
                    const valTop = schedule[getKey(nurseId, 0, d)] || '0';
                    const valBot = schedule[getKey(nurseId, 1, d)] || '0';
                    
                    // OT Calculation (Top Row Only) - Any Shift in Row 0 counts as OT
                    if (['‡∏ä','‡∏ö','‡∏î'].includes(valTop)) {
                        otCount++;
                    }

                    // Shift B/D Calculation (Bottom Row Only)
                    if (['‡∏ö','‡∏î'].includes(valBot)) {
                        bdCount++;
                    }

                    // Work Day Calculation (Bottom Row: Valid shifts)
                    if (['‡∏ä','‡∏ö','‡∏î'].includes(valBot)) {
                        workDays++;
                    }
                }

                return {
                    otCount,
                    otPay: otCount * RATES.ot,
                    bdCount,
                    bdPay: bdCount * RATES.shift_bd,
                    workDays
                };
            };

            const countDailyTotal = (day, type, scheduleToUse = schedule) => {
                let count = 0;
                nurses.forEach(n => {
                    if(scheduleToUse[getKey(n.id, 0, day)] === type) count++;
                    if(scheduleToUse[getKey(n.id, 1, day)] === type) count++;
                });
                return count;
            };

            // --- AUTO GENERATE (UPDATED LOGIC) ---
            const autoGenerateRoster = async () => {
                const confirmMsg = `üéØ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡πÄ‡∏ß‡∏£ (v38 - Equal Distribution)?\n\n` +
                                 `1. ‡∏´‡∏ô‡∏ï. = ‡πÄ‡∏ß‡∏£‡πÄ‡∏ä‡πâ‡∏≤ ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ (‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÄ‡∏î‡∏¥‡∏°)\n` +
                                 `2. ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô (‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô ‡∏´‡∏ô‡∏ï.) = ‡πÄ‡∏Å‡∏•‡∏µ‡πà‡∏¢‡πÄ‡∏ß‡∏£ ‡πÄ‡∏ä‡πâ‡∏≤, ‡∏ö‡πà‡∏≤‡∏¢, ‡∏î‡∏∂‡∏Å ‡πÉ‡∏´‡πâ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡∏Å‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î\n` +
                                 `3. Staff = 5/3/2 ‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô\n` +
                                 `4. ‡∏à‡∏±‡∏î‡∏™‡∏£‡∏£‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (${workDayLimit} ‡∏ß‡∏±‡∏ô)`;
                
                if (!confirm(confirmMsg)) return;

                setIsGenerating(true);
                await new Promise(resolve => setTimeout(resolve, 100));

                const days = getDaysInMonth();
                let newSchedule = { ...schedule };
                
                // 1. Reset
                nurses.forEach(n => {
                    for(let d=1; d<=days; d++) {
                        if(['‡∏ä','‡∏ö','‡∏î'].includes(newSchedule[getKey(n.id, 1, d)])) newSchedule[getKey(n.id, 1, d)] = '0';
                        if(['‡∏ä','‡∏ö','‡∏î'].includes(newSchedule[getKey(n.id, 0, d)])) newSchedule[getKey(n.id, 0, d)] = '0';
                    }
                });

                // Stats Tracker for Equal Distribution
                let nurseStats = {};
                nurses.forEach(n => nurseStats[n.id] = { m: 0, a: 0, n: 0, total: 0 });

                // Helper: Sort candidates to find who has the LEAST of a specific shift type
                const getSortedCandidates = (candidates, shiftType) => {
                    return [...candidates].sort((a, b) => {
                        // 1. Primary: Compare count of specific shift type (m, a, n) - Ascending
                        const typeA = nurseStats[a.id][shiftType];
                        const typeB = nurseStats[b.id][shiftType];
                        if (typeA !== typeB) return typeA - typeB;

                        // 2. Secondary: Compare total shifts - Ascending
                        return nurseStats[a.id].total - nurseStats[b.id].total;
                    });
                };

                for (let d = 1; d <= days; d++) {
                    const isRed = isHoliday(d);
                    const targetM = 5;
                    const targetA = 3;
                    const targetN = 2;

                    // --- 1. Pre-Assign HN (Original Condition) ---
                    const hn = nurses.find(isHN);
                    let hnWorked = false;
                    if (hn) {
                        // HN works Morning on non-holidays
                        if (!isRed && !NON_WORKING_CODES.includes(newSchedule[getKey(hn.id, 1, d)])) {
                            newSchedule[getKey(hn.id, 1, d)] = '‡∏ä';
                            nurseStats[hn.id].m++;
                            nurseStats[hn.id].total++;
                            hnWorked = true;
                        }
                    }

                    // --- 2. Identify Available Staff (Non-HN) ---
                    let availableIds = [];
                    nurses.forEach(n => {
                        // Skip HN from rotation pool
                        if (n.id === hn?.id) return;

                        const k1 = getKey(n.id, 1, d);
                        // Skip if on Leave
                        if (NON_WORKING_CODES.includes(newSchedule[k1])) return;
                        
                        // Rule: No work if worked Night yesterday
                        if (d > 1 && newSchedule[getKey(n.id, 1, d-1)] === '‡∏î') return;

                        availableIds.push(n.id);
                    });

                    let candidates = nurses.filter(n => availableIds.includes(n.id));
                    let assignedToday = [];

                    // --- 3. Assign Night (Priority 1) ---
                    // Sort by who has fewest Nights
                    let nightPool = getSortedCandidates(candidates, 'n');
                    let countN = 0;
                    for (let n of nightPool) {
                        if (countN < targetN) {
                            newSchedule[getKey(n.id, 1, d)] = '‡∏î';
                            assignedToday.push(n.id);
                            nurseStats[n.id].n++;     // Increment Night Count
                            nurseStats[n.id].total++; // Increment Total
                            countN++;
                        }
                    }
                    // Remove assigned form candidates
                    candidates = candidates.filter(n => !assignedToday.includes(n.id));

                    // --- 4. Assign Afternoon (Priority 2) ---
                    // Sort by who has fewest Afternoons
                    let afternoonPool = getSortedCandidates(candidates, 'a');
                    let countA = 0;
                    for (let n of afternoonPool) {
                        if (countA < targetA) {
                            newSchedule[getKey(n.id, 1, d)] = '‡∏ö';
                            assignedToday.push(n.id);
                            nurseStats[n.id].a++;     // Increment Afternoon Count
                            nurseStats[n.id].total++;
                            countA++;
                        }
                    }
                    candidates = candidates.filter(n => !assignedToday.includes(n.id));

                    // --- 5. Assign Morning (Priority 3) ---
                    // Sort by who has fewest Mornings
                    let morningPool = getSortedCandidates(candidates, 'm');
                    let countM = hnWorked ? 1 : 0; // HN counts as 1 Morning
                    
                    for (let n of morningPool) {
                        if (countM < targetM) {
                            newSchedule[getKey(n.id, 1, d)] = '‡∏ä';
                            assignedToday.push(n.id);
                            nurseStats[n.id].m++;     // Increment Morning Count
                            nurseStats[n.id].total++;
                            countM++;
                        }
                    }

                    // --- 6. Fill Gaps with OT (If needed) ---
                    // Fill M gap
                    if (countM < targetM) {
                        let needed = targetM - countM;
                        let doublePool = nurses.filter(n => newSchedule[getKey(n.id, 1, d)] === '‡∏ö'); 
                        // Pick from Afternoon team who has fewest Mornings overall
                        doublePool = getSortedCandidates(doublePool, 'm');
                        for (let n of doublePool) {
                            if (needed > 0) {
                                newSchedule[getKey(n.id, 0, d)] = '‡∏ä';
                                nurseStats[n.id].total++;
                                needed--;
                            }
                        }
                    }
                    // Fill A gap
                    if (countA < targetA) {
                        let needed = targetA - countA;
                        let doublePool = nurses.filter(n => newSchedule[getKey(n.id, 1, d)] === '‡∏ä');
                         // Pick from Morning team who has fewest Afternoons overall
                        doublePool = getSortedCandidates(doublePool, 'a');
                        for (let n of doublePool) {
                            if (needed > 0) {
                                newSchedule[getKey(n.id, 0, d)] = '‡∏ö';
                                nurseStats[n.id].total++;
                                needed--;
                            }
                        }
                    }
                }

                // --- 7. Strict Limit Adjustment ---
                // Move Excess Morning shifts to OT to match WorkDay Limit exactly
                nurses.forEach(n => {
                    let currentWorkDays = 0;
                    for(let d=1; d<=days; d++) {
                        if(['‡∏ä','‡∏ö','‡∏î'].includes(newSchedule[getKey(n.id, 1, d)])) currentWorkDays++;
                    }

                    let excess = currentWorkDays - workDayLimit;

                    // Move '‡∏ä' from Row 1 to Row 0 if excess
                    if (excess > 0) {
                        for (let d = 1; d <= days && excess > 0; d++) {
                            const k1 = getKey(n.id, 1, d);
                            const k0 = getKey(n.id, 0, d);
                            
                            if (newSchedule[k1] === '‡∏ä' && newSchedule[k0] === '0') {
                                newSchedule[k0] = '‡∏ä'; // Move to OT
                                newSchedule[k1] = '0'; // Remove from Normal
                                excess--;
                            }
                        }
                    }
                });

                setSchedule(newSchedule);
                saveAll(null, newSchedule, null, workDayLimit, customConditions);
                setIsGenerating(false);
            };

            // --- EVENT HANDLERS ---
            const handleLimitChange = (e) => {
                const val = parseInt(e.target.value) || 0;
                setWorkDayLimit(val);
                saveAll(null, null, null, val, customConditions);
            };

            const toggleHoliday = (day) => {
                const newHolidays = customHolidays.includes(day) 
                    ? customHolidays.filter(d => d !== day) 
                    : [...customHolidays, day];
                setCustomHolidays(newHolidays);
                saveAll(null, null, newHolidays, workDayLimit, customConditions);
            };

            const cycleShift = (id, row, day) => {
                const key = getKey(id, row, day);
                const current = schedule[key] || '0';
                const cycleOrder = (row === 0) ? CYCLE_TOP : CYCLE_BOTTOM;
                const nextIndex = (cycleOrder.indexOf(current) + 1) % cycleOrder.length;
                const newSchedule = { ...schedule, [key]: cycleOrder[nextIndex] };
                saveAll(null, newSchedule, null, workDayLimit, customConditions);
            };

            const handleAddNurse = () => {
                if(!newNurse.name.trim()) {
                    alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•');
                    return;
                }
                const updated = [...nurses, { id: Date.now(), name: newNurse.name, pos: newNurse.pos || 'L1' }];
                saveAll(updated, null, null, workDayLimit, customConditions);
                setNewNurse({ name: '', pos: 'L1' });
                setShowModal(false);
            };

            const handleDeleteNurse = (id) => {
                if(confirm(`üóëÔ∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?`)) {
                    saveAll(nurses.filter(n => n.id !== id), null, null, workDayLimit, customConditions);
                }
            };

            const handleSaveEdit = () => {
                if (!editingNurse.name.trim()) return;
                const updatedNurses = nurses.map(n => n.id === editingNurse.id ? { ...editingNurse } : n);
                saveAll(updatedNurses, null, null, workDayLimit, customConditions);
                setEditingNurse(null);
            };

            const clearAllData = () => {
                if(confirm("‚ö†Ô∏è ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ß‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?")) {
                    setSchedule({});
                    saveAll(null, {}, null, workDayLimit, customConditions);
                }
            };

            const exportExcel = () => {
                const wb = XLSX.utils.book_new();
                const days = Array.from({length: getDaysInMonth()}, (_, i) => i + 1);
                
                const data = [];
                data.push(['‡∏•‡∏≥‡∏î‡∏±‡∏ö', '‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•', '‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á', ...days, '‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£', '‡∏£‡∏ß‡∏° ‡∏ö/‡∏î', '‡∏Ñ‡πà‡∏≤‡πÄ‡∏ß‡∏£', '‡∏£‡∏ß‡∏° OT', '‡∏Ñ‡πà‡∏≤ OT']);
                
                nurses.forEach((n, idx) => {
                    const s = countStats(n.id);
                    const row1 = [idx + 1, n.name, n.pos];
                    days.forEach(d => row1.push(schedule[getKey(n.id, 0, d)] || '0'));
                    row1.push(s.workDays, s.bdCount, s.bdPay, s.otCount, s.otPay);
                    
                    const row2 = ['', '', ''];
                    days.forEach(d => row2.push(schedule[getKey(n.id, 1, d)] || '0'));
                    row2.push('', '', '', '', '');

                    data.push(row1, row2);
                });

                const ws = XLSX.utils.aoa_to_sheet(data);
                XLSX.utils.book_append_sheet(wb, ws, "Roster");
                XLSX.writeFile(wb, `Roster_v38_${currentDate.getMonth()+1}.xlsx`);
            };

            return (
                <div className="flex flex-col h-screen overflow-hidden">
                    {/* 1. Header & Toolbar */}
                    <div className="bg-white border-b border-gray-200 shadow-sm shrink-0 z-50">
                        <div className="p-3 flex justify-between items-center">
                            <div className="flex items-center gap-4">
                                <div className="bg-blue-600 text-white p-2 rounded-lg shadow-blue-200 shadow-md">
                                    <Calculator size={24} />
                                </div>
                                <div>
                                    <h1 className="text-xl font-bold text-gray-800">‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏£‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏• <span className="text-xs text-blue-600 bg-blue-50 px-2 py-0.5 rounded-full">v38 Equal Dist</span></h1>
                                    <div className="flex items-center gap-2 text-sm text-gray-500">
                                        <button onClick={() => setCurrentDate(new Date(currentDate.setMonth(currentDate.getMonth() - 1)))} className="hover:text-blue-600"><ChevronLeft size={16}/></button>
                                        <span className="font-semibold w-32 text-center">{currentDate.toLocaleDateString('th-TH', { month: 'long', year: 'numeric' })}</span>
                                        <button onClick={() => setCurrentDate(new Date(currentDate.setMonth(currentDate.getMonth() + 1)))} className="hover:text-blue-600"><ChevronRight size={16}/></button>
                                    </div>
                                </div>
                            </div>

                            {/* 2. Condition Input Area */}
                            <div className="flex-1 mx-6 no-print relative">
                                <span className="absolute -top-3 left-0 text-[10px] text-gray-500 bg-white px-1">‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏û‡∏¥‡πÄ‡∏®‡∏© / ‡∏Å‡∏é‡πÄ‡∏´‡∏•‡πá‡∏Å</span>
                                <textarea
                                    value={customConditions}
                                    onChange={(e) => saveAll(null, null, null, workDayLimit, e.target.value)}
                                    className="w-full bg-yellow-50/50 border border-yellow-200 rounded-lg py-2 px-3 text-xs focus:ring-2 focus:ring-yellow-400 focus:outline-none resize-none h-10 transition-all focus:h-20 shadow-sm placeholder-gray-400"
                                    placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏ß‡∏£‡∏î‡∏∂‡∏Å‡∏ï‡∏¥‡∏î‡∏Å‡∏±‡∏ô, L1 ‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 15..."
                                />
                            </div>

                            <div className="flex items-center gap-2 no-print">
                                <div className="flex items-center gap-2 bg-gray-100 px-3 py-1.5 rounded-lg border border-gray-200">
                                    <Settings size={14} className="text-gray-500"/>
                                    <span className="text-xs font-medium text-gray-600">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£:</span>
                                    <input 
                                        type="number" 
                                        value={workDayLimit} 
                                        onChange={handleLimitChange}
                                        className="w-10 text-center text-sm font-bold bg-white border border-gray-300 rounded focus:ring-1 focus:ring-blue-500"
                                    />
                                </div>

                                <button onClick={autoGenerateRoster} disabled={isGenerating} className="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-2 rounded-lg text-sm font-bold shadow-sm flex items-center gap-1 transition-transform active:scale-95">
                                    {isGenerating ? <div className="spinner w-4 h-4 border-white"></div> : <Zap size={16} />} 
                                    <span>Auto</span>
                                </button>
                                
                                <button onClick={() => setShowModal(true)} className="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg text-sm font-bold shadow-sm flex items-center gap-1 transition-transform active:scale-95">
                                    <UserPlus size={16} /> 
                                    <span>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ô</span>
                                </button>
                                
                                <button onClick={exportExcel} className="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg text-sm font-bold shadow-sm flex items-center gap-1 transition-transform active:scale-95">
                                    <Download size={16} /> 
                                    <span>Excel</span>
                                </button>

                                <button onClick={clearAllData} className="bg-gray-200 hover:bg-red-500 hover:text-white text-gray-600 px-3 py-2 rounded-lg text-sm font-bold shadow-sm transition-colors">
                                    <Eraser size={16} />
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* 3. Main Table Area */}
                    <div className="flex-1 overflow-auto bg-gray-100 p-4">
                        {/* Wrapper to handle scrolling - overflow-x-auto enables horizontal scroll */}
                        <div className="bg-white rounded-lg shadow-lg border border-gray-200 overflow-x-auto max-w-full">
                            <table className="w-full min-w-max">
                                <thead>
                                    <tr>
                                        <th className="sticky-1 w-[40px]">No.</th>
                                        <th className="sticky-2 w-[160px]">‡∏ä‡∏∑‡πà‡∏≠ - ‡∏™‡∏Å‡∏∏‡∏•</th>
                                        <th className="sticky-3 w-[70px]">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</th>
                                        {Array.from({ length: getDaysInMonth() }, (_, i) => {
                                            const day = i + 1;
                                            const isRed = isHoliday(day);
                                            const dateObj = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
                                            const dayName = ['‡∏≠‡∏≤','‡∏à','‡∏≠','‡∏û','‡∏û‡∏§','‡∏®','‡∏™'][dateObj.getDay()];
                                            return (
                                                <th 
                                                    key={i} 
                                                    onClick={() => toggleHoliday(day)}
                                                    className={`min-w-[36px] cursor-pointer hover:bg-gray-200 transition-colors ${isRed ? 'bg-red-50 text-red-600' : ''}`}
                                                >
                                                    <div className="flex flex-col items-center leading-tight">
                                                        <span className="text-[13px] font-bold">{day}</span>
                                                        <span className="text-[10px] font-normal">{dayName}</span>
                                                    </div>
                                                </th>
                                            );
                                        })}
                                        {/* Right Summary Columns - ensured visible via scrolling */}
                                        <th className="bg-blue-50 text-blue-900 border-l-2 border-blue-200 min-w-[60px] px-1">‡∏ß‡∏±‡∏ô<br/>‡∏ó‡∏≥‡∏Å‡∏≤‡∏£</th>
                                        <th className="bg-yellow-50 text-yellow-900 border-l border-yellow-200 min-w-[60px] px-1">‡∏£‡∏ß‡∏°<br/>‡∏ö‡πà‡∏≤‡∏¢/‡∏î‡∏∂‡∏Å</th>
                                        <th className="bg-green-50 text-green-900 border-l border-green-200 min-w-[70px] px-1">‡∏£‡∏≤‡∏Ñ‡∏≤<br/>(360)</th>
                                        <th className="bg-orange-50 text-orange-900 border-l-2 border-orange-200 min-w-[60px] px-1">‡∏£‡∏ß‡∏°<br/>OT</th>
                                        <th className="bg-orange-100 text-orange-900 border-l border-orange-200 min-w-[70px] px-1">‡∏£‡∏≤‡∏Ñ‡∏≤<br/>(800)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {nurses.map((nurse, idx) => {
                                        const s = countStats(nurse.id);
                                        const isBalanced = s.workDays === workDayLimit;
                                        
                                        return (
                                            <React.Fragment key={nurse.id}>
                                                {/* Top Row: OT & Stats */}
                                                <tr className="border-b-0 hover:bg-gray-50">
                                                    <td rowSpan={2} className="sticky-1 font-bold text-gray-500 bg-white">{idx + 1}</td>
                                                    <td rowSpan={2} className="sticky-2 text-left px-2 bg-white">
                                                        {editingNurse?.id === nurse.id ? (
                                                            <div className="flex flex-col gap-1 z-50 relative">
                                                                <input 
                                                                    autoFocus
                                                                    className="border rounded px-1 text-sm w-full"
                                                                    value={editingNurse.name} 
                                                                    onChange={e => setEditingNurse({...editingNurse, name: e.target.value})} 
                                                                />
                                                                <div className="flex gap-1">
                                                                    <button onClick={handleSaveEdit} className="bg-green-500 text-white text-xs px-2 rounded">Save</button>
                                                                    <button onClick={() => setEditingNurse(null)} className="bg-gray-300 text-black text-xs px-2 rounded">Cancel</button>
                                                                </div>
                                                            </div>
                                                        ) : (
                                                            <div className="flex justify-between items-center group">
                                                                <span className="truncate max-w-[100px]" title={nurse.name}>{nurse.name}</span>
                                                                <div className="hidden group-hover:flex gap-1">
                                                                    <Edit2 size={12} className="cursor-pointer text-blue-500" onClick={() => setEditingNurse(nurse)}/>
                                                                    <Trash2 size={12} className="cursor-pointer text-red-500" onClick={() => handleDeleteNurse(nurse.id)}/>
                                                                </div>
                                                            </div>
                                                        )}
                                                    </td>
                                                    <td rowSpan={2} className="sticky-3 font-semibold text-gray-600 bg-white">
                                                        {editingNurse?.id === nurse.id ? (
                                                            <select 
                                                                className="border rounded text-xs w-full"
                                                                value={editingNurse.pos}
                                                                onChange={e => setEditingNurse({...editingNurse, pos: e.target.value})}
                                                            >
                                                                <option value="‡∏´‡∏ô‡∏ï.">‡∏´‡∏ô‡∏ï.</option>
                                                                <option value="L5">L5</option>
                                                                <option value="L4">L4</option>
                                                                <option value="L2">L2</option>
                                                                <option value="L1">L1</option>
                                                            </select>
                                                        ) : nurse.pos}
                                                    </td>
                                                    
                                                    {/* Days (OT Row) */}
                                                    {Array.from({ length: getDaysInMonth() }, (_, i) => {
                                                        const d = i + 1;
                                                        const val = schedule[getKey(nurse.id, 0, d)] || '0';
                                                        return (
                                                            <td 
                                                                key={`ot-${d}`} 
                                                                onClick={() => cycleShift(nurse.id, 0, d)}
                                                                className={`cell-hover text-xs ${val !== '0' ? 'font-bold text-red-600 bg-red-50' : 'text-gray-200'}`}
                                                            >
                                                                {val}
                                                            </td>
                                                        );
                                                    })}

                                                    {/* Stats Columns - Data */}
                                                    <td rowSpan={2} className={`font-bold text-sm border-l-2 border-blue-200 ${isBalanced ? 'text-green-600 bg-green-50' : 'text-red-500 bg-white'}`}>
                                                        {s.workDays}
                                                        {!isBalanced && <div className="text-[9px] font-normal text-gray-400">{s.workDays - workDayLimit > 0 ? `+${s.workDays - workDayLimit}` : `${s.workDays - workDayLimit}`}</div>}
                                                    </td>
                                                    <td rowSpan={2} className="bg-yellow-50 font-semibold border-l border-yellow-200">{s.bdCount}</td>
                                                    <td rowSpan={2} className="bg-green-50 text-gray-600 text-xs border-l border-green-200">{s.bdPay > 0 ? s.bdPay.toLocaleString() : '-'}</td>
                                                    <td rowSpan={2} className="bg-orange-50 font-bold text-orange-700 border-l-2 border-orange-200">{s.otCount}</td>
                                                    <td rowSpan={2} className="bg-orange-100 text-orange-800 font-semibold text-xs border-l border-orange-200">{s.otPay > 0 ? s.otPay.toLocaleString() : '-'}</td>
                                                </tr>

                                                {/* Bottom Row: Normal Shifts */}
                                                <tr className="border-b border-gray-300">
                                                    {Array.from({ length: getDaysInMonth() }, (_, i) => {
                                                        const d = i + 1;
                                                        const val = schedule[getKey(nurse.id, 1, d)] || '0';
                                                        const style = SHIFT_TYPES[val] || SHIFT_TYPES['0'];
                                                        return (
                                                            <td 
                                                                key={`norm-${d}`} 
                                                                onClick={() => cycleShift(nurse.id, 1, d)}
                                                                className={`cell-hover text-xs ${style.color}`}
                                                            >
                                                                {val}
                                                            </td>
                                                        );
                                                    })}
                                                </tr>
                                            </React.Fragment>
                                        );
                                    })}
                                </tbody>
                                <tfoot>
                                    {/* Footer Summary aligned to Day 1 */}
                                    <tr className="bg-gray-100 font-bold text-xs text-gray-600 border-t-2 border-gray-300">
                                        <td colSpan="3" className="sticky-1 text-right pr-2 bg-gray-100 z-40">‡∏£‡∏ß‡∏° ‡πÄ‡∏ä‡πâ‡∏≤</td>
                                        {Array.from({ length: getDaysInMonth() }, (_, i) => {
                                            const day = i + 1;
                                            // Count both rows for staffing check (Normal + OT)
                                            const c = countDailyTotal(day, '‡∏ä');
                                            // Target Logic: Every day 5
                                            const target = 5;
                                            const statusColor = c < target ? 'text-red-600 bg-red-100' : (c > target ? 'text-blue-600 bg-blue-100' : 'text-green-700 bg-green-100');
                                            
                                            return <td key={i} className={statusColor}>{c || '-'}</td>;
                                        })}
                                        <td colSpan="5" className="bg-gray-200"></td>
                                    </tr>
                                    <tr className="bg-gray-100 font-bold text-xs text-gray-600">
                                        <td colSpan="3" className="sticky-1 text-right pr-2 bg-gray-100 z-40">‡∏£‡∏ß‡∏° ‡∏ö‡πà‡∏≤‡∏¢</td>
                                        {Array.from({ length: getDaysInMonth() }, (_, i) => {
                                            const day = i + 1;
                                            const c = countDailyTotal(day, '‡∏ö');
                                            // Target Logic: Every day 3
                                            const target = 3;
                                            const statusColor = c < target ? 'text-red-600 bg-red-100' : (c > target ? 'text-blue-600 bg-blue-100' : 'text-yellow-700 bg-yellow-100');
                                            
                                            return <td key={i} className={statusColor}>{c || '-'}</td>;
                                        })}
                                        <td colSpan="5" className="bg-gray-200"></td>
                                    </tr>
                                    <tr className="bg-gray-100 font-bold text-xs text-gray-600 border-b-2 border-gray-300">
                                        <td colSpan="3" className="sticky-1 text-right pr-2 bg-gray-100 z-40">‡∏£‡∏ß‡∏° ‡∏î‡∏∂‡∏Å</td>
                                        {Array.from({ length: getDaysInMonth() }, (_, i) => {
                                            const day = i + 1;
                                            const c = countDailyTotal(day, '‡∏î');
                                            // Target Logic: Every day 2
                                            const target = 2;
                                            const statusColor = c < target ? 'text-red-600 bg-red-100' : (c > target ? 'text-blue-600 bg-blue-100' : 'text-purple-700 bg-purple-100');

                                            return <td key={i} className={statusColor}>{c || '-'}</td>;
                                        })}
                                        <td colSpan="5" className="bg-gray-200"></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>

                    {/* 4. Legend Footer */}
                    <div className="bg-white p-2 border-t border-gray-200 text-[11px] text-gray-600 flex justify-center gap-4 shrink-0 no-print">
                        <span className="font-bold">‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå:</span>
                        <span className="px-2 py-0.5 rounded bg-green-100 text-green-800">‡∏ä (‡πÄ‡∏ä‡πâ‡∏≤)</span>
                        <span className="px-2 py-0.5 rounded bg-yellow-100 text-yellow-800">‡∏ö (‡∏ö‡πà‡∏≤‡∏¢) 360‡∏ø</span>
                        <span className="px-2 py-0.5 rounded bg-purple-100 text-purple-800">‡∏î (‡∏î‡∏∂‡∏Å) 360‡∏ø</span>
                        <span className="px-2 py-0.5 rounded bg-red-50 text-red-600 font-bold border border-red-200">‡∏ï‡∏±‡∏ß‡πÅ‡∏î‡∏á‡πÅ‡∏ñ‡∏ß‡∏ö‡∏ô (OT) 800‡∏ø</span>
                    </div>

                    {/* Modals */}
                    {showModal && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[100]">
                            <div className="bg-white p-6 rounded-lg shadow-xl w-80">
                                <h3 className="text-lg font-bold mb-4">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•</h3>
                                <input className="w-full border p-2 mb-2 rounded" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•" value={newNurse.name} onChange={e => setNewNurse({...newNurse, name: e.target.value})} />
                                <select className="w-full border p-2 mb-4 rounded" value={newNurse.pos} onChange={e => setNewNurse({...newNurse, pos: e.target.value})}>
                                    <option value="‡∏´‡∏ô‡∏ï.">‡∏´‡∏ô‡∏ï.</option>
                                    <option value="L5">L5</option>
                                    <option value="L4">L4</option>
                                    <option value="L2">L2</option>
                                    <option value="L1">L1</option>
                                </select>
                                <div className="flex justify-end gap-2">
                                    <button onClick={() => setShowModal(false)} className="px-4 py-2 bg-gray-200 rounded">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                                    <button onClick={handleAddNurse} className="px-4 py-2 bg-blue-600 text-white rounded">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<RosterApp />);
    </script>
</body>
</html>
