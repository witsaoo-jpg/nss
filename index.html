<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ระบบจัดเวรพยาบาลอัจฉริยะ</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#06b6d4;--muted:#94a3b8;--glass:rgba(255,255,255,0.04)}
    *{box-sizing:border-box;font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial}
    body{margin:0;min-height:100vh;background:linear-gradient(180deg,#071021 0%,#081526 60%);color:#e6eef6;padding:28px}
    .app{max-width:1200px;margin:0 auto}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:18px}
    h1{font-size:20px;margin:0}
    p.lead{margin:0;color:var(--muted);font-size:13px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:14px;padding:14px;box-shadow:0 6px 24px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.03)}
    .controls{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-top:12px}
    .flex{display:flex;gap:8px;align-items:center}
    input,select,button,textarea{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 10px;border-radius:8px;color:inherit}
    button{cursor:pointer;background:var(--accent);color:#022; font-weight:600;border:none}
    .muted{color:var(--muted);font-size:13px}
    .leftcol{width:320px;display:flex;flex-direction:column;gap:12px}
    .layout{display:flex;gap:16px}
    .nurses-list{max-height:360px;overflow:auto;padding:8px;display:flex;flex-direction:column;gap:8px}
    .nurse-item{display:flex;justify-content:space-between;gap:8px;padding:8px;background:var(--glass);border-radius:8px}
    .nurse-item .name{font-weight:600}
    .roster{flex:1;overflow:auto}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:8px;border:1px solid rgba(255,255,255,0.04);text-align:center}
    th{background:rgba(255,255,255,0.02);font-weight:700}
    td.shift{min-width:120px}
    .chip{display:inline-block;padding:6px 8px;border-radius:999px;background:rgba(255,255,255,0.03);cursor:pointer}
    .stats{display:flex;gap:12px;flex-wrap:wrap;margin-top:10px}
    .stat{background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;min-width:120px;text-align:left}
    .toolbar{display:flex;gap:8px;align-items:center}
    .small{font-size:12px;padding:6px 8px}
    .export-area{width:100%;height:120px;background:rgba(255,255,255,0.02);border-radius:8px;padding:8px;color:var(--muted);resize:vertical}
    .hint{font-size:12px;color:var(--muted)}
    footer{margin-top:12px;color:var(--muted);font-size:12px}
    /* responsive */
    @media (max-width:900px){.layout{flex-direction:column}.leftcol{width:100%}}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>ระบบจัดเวรพยาบาลอัจฉริยะ</h1>
        <p class="lead">สร้างตารางเวรอัตโนมัติ กระจายภาระอย่างเท่าเทียม รองรับเช้า/บ่าย/ดึก — ไม่ใช้ localStorage (เก็บในหน่วยความจำของหน้า)</p>
      </div>
      <div class="toolbar">
        <button id="autoGen">สร้างตารางอัตโนมัติ</button>
        <button id="clear">ล้างตาราง</button>
        <button id="download">ดาวน์โหลด JSON</button>
      </div>
    </header>

    <div class="layout">
      <aside class="leftcol card">
        <div>
          <strong>จัดการพยาบาล</strong>
          <div class="muted">เพิ่มชื่อแล้วกด +</div>
        </div>
        <div class="flex">
          <input id="nurseName" placeholder="ชื่อพยาบาล" />
          <button id="addNurse">+</button>
        </div>
        <div class="nurses-list card" id="nursesList" style="padding:10px"></div>

        <div style="margin-top:6px">
          <strong>ตั้งค่าเวร</strong>
          <div class="muted">จำนวนวันและกะ</div>
        </div>
        <div class="controls">
          <div>
            <label class="muted">วัน (เริ่มจาก)</label>
            <input type="date" id="startDate" />
          </div>
          <div>
            <label class="muted">จำนวนวัน</label>
            <select id="days">
              <option value="7">7 วัน (1 สัปดาห์)</option>
              <option value="14">14 วัน</option>
              <option value="28">28 วัน</option>
            </select>
          </div>
        </div>
        <div class="controls">
          <div>
            <label class="muted">กะ</label>
            <select id="shifts" multiple>
              <option value="M" selected>เช้า (M)</option>
              <option value="A" selected>บ่าย (A)</option>
              <option value="N" selected>ดึก (N)</option>
            </select>
            <div class="hint">กด Ctrl/Command เพื่อเลือกหลายกะ</div>
          </div>
          <div>
            <label class="muted">กะต่อวัน</label>
            <select id="perDay">
              <option value="1">1 คน/กะ</option>
              <option value="2" selected>2 คน/กะ</option>
            </select>
          </div>
        </div>

        <div style="margin-top:8px">
          <strong>สรุปการแจกงาน (ตัวอย่าง)</strong>
          <div class="stats" id="stats"></div>
        </div>

      </aside>

      <main class="roster card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <strong>ตารางเวรรายสัปดาห์</strong>
            <div class="muted">คลิกที่ cell เพื่อเปลี่ยนพยาบาล</div>
          </div>
          <div class="muted">หมายเหตุ: ระบบเก็บข้อมูลชั่วคราวในหน้านี้เท่านั้น</div>
        </div>

        <div id="rosterWrap" style="margin-top:12px;overflow:auto"></div>

        <div style="margin-top:12px">
          <strong>JSON ของตาราง (Export/Import)</strong>
          <textarea id="jsonArea" class="export-area" placeholder='วาง JSON ที่นี่ เพื่อ Import'></textarea>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="importJson" class="small">Import JSON</button>
            <button id="resetNurses" class="small">Reset รายชื่อ</button>
          </div>
        </div>

      </main>
    </div>

    <footer class="muted">ออกแบบโดย ChatGPT — ปรับแต่งอัลกอริทึมได้ตามนโยบายโรงพยาบาล (ตัวอย่างนี้ไม่เชื่อมฐานข้อมูล)</footer>
  </div>

<script>
// === Model (in-memory) ===
const DB = {
  nurses: [], // {id,name}
  roster: {}, // dayIndex -> shift -> [nurseIds]
  settings: {
    startDate: null,
    days: 7,
    shifts: ['M','A','N'],
    perShift: 2
  }
};
let idCounter = 1;

// === Utils ===
const $ = id => document.getElementById(id);
function uid(){return 'n'+(idCounter++)}
function formatDateISO(d){return d.toISOString().slice(0,10)}
function addDays(d, n){const x=new Date(d);x.setDate(x.getDate()+n);return x}

// === UI Binding ===
function renderNurses(){
  const wrap = $('nursesList');wrap.innerHTML='';
  DB.nurses.forEach(n=>{
    const el = document.createElement('div');el.className='nurse-item';
    el.innerHTML = `<div><div class="name">${n.name}</div><div class="muted">id:${n.id}</div></div>`;
    const r = document.createElement('div');
    const del = document.createElement('button');del.textContent='ลบ';del.className='small';del.onclick=()=>{DB.nurses=DB.nurses.filter(x=>x.id!==n.id);renderNurses();renderRoster();}
    r.appendChild(del);
    el.appendChild(r);wrap.appendChild(el);
  });
}

function renderRoster(){
  const wrap = $('rosterWrap');
  const days = DB.settings.days;const shifts = DB.settings.shifts;const per = DB.settings.perShift;const start = DB.settings.startDate?new Date(DB.settings.startDate):new Date();
  const table = document.createElement('table');
  const thead = document.createElement('thead');
  const trh = document.createElement('tr');
  trh.appendChild(document.createElement('th'));
  for(let i=0;i<days;i++){
    const d = addDays(new Date(start), i);
    const th = document.createElement('th');th.innerHTML = `${formatDateISO(d)}<div class='muted'>${d.toLocaleDateString('th-TH',{weekday:'short'})}</div>`;trh.appendChild(th);
  }
  thead.appendChild(trh);table.appendChild(thead);

  const tbody = document.createElement('tbody');
  shifts.forEach(shift=>{
    const tr = document.createElement('tr');
    const th = document.createElement('th');th.textContent = shift;tr.appendChild(th);
    for(let d=0;d<days;d++){
      const td = document.createElement('td');td.className='shift';
      const assigned = ((DB.roster[d] && DB.roster[d][shift])?DB.roster[d][shift]:[]);
      // show slots
      for(let s=0;s<per;s++){
        const nid = assigned[s] || null;
        const chip = document.createElement('span');chip.className='chip';chip.textContent = nid? (DB.nurses.find(x=>x.id===nid)?.name || '---') : 'ว่าง';
        chip.onclick = ()=> openAssignPopup(d,shift,s);
        td.appendChild(chip);
      }
      tr.appendChild(td);
    }
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
  wrap.innerHTML='';wrap.appendChild(table);
  renderStats();
}

function renderStats(){
  const container = $('stats');container.innerHTML='';
  const counts = {};
  DB.nurses.forEach(n=>counts[n.id]=0);
  Object.keys(DB.roster).forEach(d=>{
    Object.keys(DB.roster[d]).forEach(sh=>{
      (DB.roster[d][sh]||[]).forEach(id=>{if(id)counts[id]=(counts[id]||0)+1});
    });
  });
  DB.nurses.forEach(n=>{
    const el = document.createElement('div');el.className='stat';el.innerHTML = `<div style="font-weight:700">${n.name}</div><div class='muted'>เวรทั้งหมด: ${counts[n.id]||0}</div>`;container.appendChild(el);
  });
}

// === Assign popup (simple prompt) ===
function openAssignPopup(day,shift,slot){
  const names = ['ว่าง',...DB.nurses.map(n=>n.name)];
  const selIndex = prompt('เลือกพยาบาล (พิมพ์เลข):\n' + names.map((nm,i)=>`${i}: ${nm}`).join('\n'), '0');
  if(selIndex==null) return;
  const idx = parseInt(selIndex);
  if(isNaN(idx)) return alert('กรอกตัวเลขเท่านั้น');
  const nurseId = idx===0?null:DB.nurses[idx-1].id;
  DB.roster[day] = DB.roster[day] || {};
  DB.roster[day][shift] = DB.roster[day][shift] || [];
  DB.roster[day][shift][slot] = nurseId;
  renderRoster();
}

// === Smart scheduling algorithm ===
function generateSmartRoster(){
  // simple fair-rotation algorithm with constraints: try to avoid consecutive night shifts per nurse when possible
  const nurses = DB.nurses.map(n=>n.id);
  const days = DB.settings.days;const shifts = DB.settings.shifts; const per = DB.settings.perShift;
  if(nurses.length===0) return alert('ยังไม่มีพยาบาล');
  // initialize counts
  const counts = {}; nurses.forEach(id=>counts[id]=0);
  // initialize roster
  DB.roster = {};
  for(let d=0;d<days;d++){
    DB.roster[d] = {};
    for(const sh of shifts){
      DB.roster[d][sh] = [];
      for(let slot=0;slot<per;slot++){
        // choose nurse with minimum count, prefer those without night previous if sh==='N'
        const candidates = nurses.slice().sort((a,b)=>counts[a]-counts[b]);
        let choice = candidates.find(c=>{
          // avoid consecutive night: if current shift is N and previous day assigned N contains c, skip
          if(sh==='N' && d>0){
            const prevN = DB.roster[d-1] && DB.roster[d-1]['N'] || [];
            if(prevN.includes(c)) return false;
          }
          return true;
        });
        if(!choice) choice = candidates[0];
        DB.roster[d][sh].push(choice);
        counts[choice]++;
      }
    }
  }
}

// === Controls wiring ===
$('addNurse').onclick = ()=>{
  const v = $('nurseName').value.trim(); if(!v) return; const id=uid(); DB.nurses.push({id,name:v}); $('nurseName').value=''; renderNurses(); renderRoster(); }

$('autoGen').onclick = ()=>{
  // read settings
  const sd = $('startDate').value; DB.settings.startDate = sd?sd:formatDateISO(new Date());
  DB.settings.days = parseInt($('days').value);
  DB.settings.shifts = Array.from($('shifts').selectedOptions).map(x=>x.value);
  DB.settings.perShift = parseInt($('perDay').value);
  generateSmartRoster(); renderRoster(); alert('สร้างตารางเรียบร้อย');
}

$('clear').onclick = ()=>{if(confirm('ล้างตารางและรายชื่อ?')){DB.nurses=[];DB.roster={};renderNurses();renderRoster();$('jsonArea').value='';}}

$('download').onclick = ()=>{
  const payload = {nurses:DB.nurses, roster:DB.roster, settings:DB.settings};
  const blob = new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
  const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='roster.json'; a.click(); URL.revokeObjectURL(url);
}

$('importJson').onclick = ()=>{
  try{
    const obj = JSON.parse($('jsonArea').value);
    if(obj.nurses) DB.nurses = obj.nurses; if(obj.roster) DB.roster = obj.roster; if(obj.settings) DB.settings = obj.settings;
    renderNurses(); renderRoster(); alert('Import สำเร็จ');
  }catch(e){alert('JSON ไม่ถูกต้อง')}
}

$('resetNurses').onclick = ()=>{if(confirm('รีเซ็ตรายชื่อพยาบาลทั้งหมด?')){DB.nurses=[];renderNurses();renderRoster();}}

// initialize
(function init(){
  // sample data
  DB.nurses = [ {id:uid(),name:'พยาบาล ก'}, {id:uid(),name:'พยาบาล ข'}, {id:uid(),name:'พยาบาล ค'}, {id:uid(),name:'พยาบาล ง'} ];
  const todayISO = formatDateISO(new Date()); $('startDate').value = todayISO; DB.settings.startDate = todayISO;
  renderNurses(); renderRoster();
})();

</script>
</body>
</html>
