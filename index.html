<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ตารางเวร (Final Compact 120px)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.294.0",
            "xlsx": "https://cdn.sheetjs.com/xlsx-0.20.1/package/xlsx.mjs"
        }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { font-family: 'Sarabun', sans-serif; }
        
        /* Scrollbar */
        .overflow-x-auto::-webkit-scrollbar { height: 10px; }
        .overflow-x-auto::-webkit-scrollbar-track { background: #f1f5f9; }
        .overflow-x-auto::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 5px; }
        .overflow-x-auto::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        table { border-spacing: 0; }
        th, td {
            white-space: nowrap;
            text-align: center;
            border: 1px solid #e2e8f0;
            height: 30px;
            padding: 0 2px;
            font-size: 13px;
        }

        /* --- ปรับขนาดคอลัมน์ให้สมดุลที่สุด (120px) --- */
        
        /* Col 1: No -> 30px */
        .sticky-1 { 
            position: sticky; 
            left: 0; 
            width: 30px; 
            min-width: 30px; 
            max-width: 30px;
            background-color: white; 
            border-right: 1px solid #e2e8f0; 
            z-index: 35;
        }
        
        /* Col 2: Name -> 120px (จุดสมดุลระหว่างชื่อสั้น/ยาว) */
        .sticky-2 { 
            position: sticky; 
            left: 30px; 
            width: 120px; 
            min-width: 120px; 
            max-width: 120px;
            background-color: white; 
            border-right: 2px solid #94a3b8; /* เส้นแบ่งชัดขึ้น */
            box-shadow: 2px 0 5px rgba(0,0,0,0.05); /* เงาบางๆ ให้รู้ว่าเป็นคนละส่วน */
            z-index: 35;
        }
        
        thead tr th { position: sticky; top: 0; z-index: 40; background-color: #f8fafc; }
        thead tr th.sticky-1, thead tr th.sticky-2 { z-index: 50; }

        .cell-hover:hover { filter: brightness(0.95); cursor: pointer; }
        .header-hover:hover { background-color: #e2e8f0; cursor: pointer; user-select: none; }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Download, Calculator, UserPlus, Trash2, ChevronLeft, ChevronRight } from 'lucide-react';
        import * as XLSX from 'xlsx';

        const RATES = { shift: 600, ot: 600 };

        const SHIFT_TYPES = {
            '0':      { label: '0',      color: 'bg-white text-gray-300 font-medium' },
            'ช':      { label: 'ช',      color: 'bg-green-50 text-green-700 font-bold' },
            'บ':      { label: 'บ',      color: 'bg-yellow-50 text-yellow-700 font-bold' },
            'ด':      { label: 'ด',      color: 'bg-purple-50 text-purple-700 font-bold' },
            'Va':     { label: 'Va',     color: 'bg-blue-50 text-blue-700 font-bold text-xs' },
            'ปช':     { label: 'ปช',     color: 'bg-orange-50 text-orange-700 font-bold text-xs' },
            'ลาป่วย': { label: 'ลาป่วย', color: 'bg-red-100 text-red-700 font-bold text-[10px]' },
            'ลากิจ':  { label: 'ลากิจ',  color: 'bg-indigo-100 text-indigo-700 font-bold text-[10px]' }
        };
        
        const CYCLE_TOP = ['0', 'ช', 'บ', 'ด']; 
        const CYCLE_BOTTOM = ['0', 'ช', 'บ', 'ด', 'Va', 'ปช', 'ลาป่วย', 'ลากิจ'];

        const INITIAL_NURSES = [
            { id: 1, name: "นางสงบ จันทร์ธรรม" },
            { id: 2, name: "นายวิษณุกรณ์ โยยา" },
        ];

        export default function RosterApp() {
            const [currentDate, setCurrentDate] = useState(new Date());
            const [nurses, setNurses] = useState(INITIAL_NURSES);
            const [schedule, setSchedule] = useState({}); 
            const [customHolidays, setCustomHolidays] = useState([]);
            const [showModal, setShowModal] = useState(false);
            const [newNurseName, setNewNurseName] = useState('');

            // Storage Key v15
            useEffect(() => {
                const savedData = localStorage.getItem('roster_data_v15');
                const savedNurses = localStorage.getItem('roster_nurses_v15');
                const savedHolidays = localStorage.getItem('roster_holidays_v15');
                
                if (savedData) setSchedule(JSON.parse(savedData));
                if (savedNurses) setNurses(JSON.parse(savedNurses));
                if (savedHolidays) setCustomHolidays(JSON.parse(savedHolidays));
            }, []);

            const saveAll = (updatedNurses, updatedSchedule, updatedHolidays) => {
                if(updatedNurses) {
                    setNurses(updatedNurses);
                    localStorage.setItem('roster_nurses_v15', JSON.stringify(updatedNurses));
                }
                if(updatedSchedule) {
                    setSchedule(updatedSchedule);
                    localStorage.setItem('roster_data_v15', JSON.stringify(updatedSchedule));
                }
                if(updatedHolidays) {
                    setCustomHolidays(updatedHolidays);
                    localStorage.setItem('roster_holidays_v15', JSON.stringify(updatedHolidays));
                }
            };

            const getDaysInMonth = () => new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();
            const getKey = (id, row, day) => `${id}-${row}-${day}`;

            const toggleHoliday = (day) => {
                let newHolidays;
                if (customHolidays.includes(day)) {
                    newHolidays = customHolidays.filter(d => d !== day);
                } else {
                    newHolidays = [...customHolidays, day];
                }
                setCustomHolidays(newHolidays);
                saveAll(null, null, newHolidays);
            };

            const cycleShift = (id, row, day) => {
                const key = getKey(id, row, day);
                const current = schedule[key] || '0';
                const cycleOrder = (row === 0) ? CYCLE_TOP : CYCLE_BOTTOM;
                const nextIndex = (cycleOrder.indexOf(current) + 1) % cycleOrder.length;
                const nextShift = cycleOrder[nextIndex];
                const newSchedule = { ...schedule, [key]: nextShift };
                saveAll(null, newSchedule, null);
            };

            const handleAddNurse = () => {
                if(!newNurseName) return;
                const updated = [...nurses, { id: Date.now(), name: newNurseName }];
                saveAll(updated, null, null);
                setNewNurseName('');
                setShowModal(false);
            };

            const handleDeleteNurse = (id) => {
                if(confirm('ต้องการลบรายชื่อนี้ใช่หรือไม่?')) {
                    saveAll(nurses.filter(n => n.id !== id), null, null);
                }
            };

            const countStats = (nurseId) => {
                let s = { bdCount: 0, bdPay: 0, otCount: 0, otPay: 0, workDays: 0 };
                const days = getDaysInMonth();
                for(let d=1; d<=days; d++) {
                    const topVal = schedule[getKey(nurseId, 0, d)] || '0';
                    const botVal = schedule[getKey(nurseId, 1, d)] || '0';

                    if (topVal !== '0') s.otCount++;
                    if (botVal === 'บ' || botVal === 'ด') s.bdCount++;

                    const isTopWork = topVal !== '0';
                    const isBotWork = ['ช', 'บ', 'ด', 'Va', 'ปช'].includes(botVal);
                    if (isTopWork || isBotWork) s.workDays++;
                }
                s.bdPay = s.bdCount * RATES.shift;
                s.otPay = s.otCount * RATES.ot;
                return s;
            };

            const countDaily = (day, type) => {
                let count = 0;
                nurses.forEach(n => {
                    [0, 1].forEach(r => {
                        if(schedule[getKey(n.id, r, day)] === type) count++;
                    });
                });
                return count;
            };

            const exportExcel = () => {
                const wb = XLSX.utils.book_new();
                const days = Array.from({length: getDaysInMonth()}, (_, i) => i + 1);
                const header = ['No', 'ชื่อ-สกุล', ...days, 'รวมเวร บ-ด', 'ค่าเวร', 'รวม OT', 'ค่า OT', 'วันทำการ'];
                const data = [];

                nurses.forEach((n, idx) => {
                    const s = countStats(n.id);
                    const r1 = [idx + 1, n.name];
                    days.forEach(d => {
                        const val = schedule[getKey(n.id, 0, d)] || '0';
                        r1.push(val !== '0' ? `${val}(OT)` : '0');
                    });
                    r1.push(s.bdCount, s.bdPay, s.otCount, s.otPay, s.workDays);
                    
                    const r2 = ['', ''];
                    days.forEach(d => r2.push(schedule[getKey(n.id, 1, d)] || '0'));
                    r2.push('', '', '', '', ''); 

                    data.push(r1, r2);
                });

                const ws = XLSX.utils.aoa_to_sheet([header, ...data]);
                XLSX.utils.book_append_sheet(wb, ws, "Roster");
                XLSX.writeFile(wb, `ตารางเวร_${currentDate.getMonth()+1}.xlsx`);
            };

            const isHoliday = (day) => {
                const date = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
                const isWeekend = [0, 6].includes(date.getDay());
                return isWeekend || customHolidays.includes(day);
            };

            return (
                <div className="min-h-screen bg-gray-100 flex flex-col h-screen">
                    {/* Header */}
                    <div className="bg-blue-600 text-white p-4 flex justify-between items-center shadow-md shrink-0 z-50">
                        <div>
                            <h1 className="text-xl font-bold flex items-center gap-2">
                                <Calculator size={24}/> ตารางจัดเวร (v15)
                            </h1>
                            <p className="text-blue-100 text-sm mt-1">
                                เดือน {currentDate.toLocaleDateString('th-TH', { month: 'long', year: 'numeric' })}
                            </p>
                        </div>
                        <div className="flex items-center gap-3">
                             <div className="flex bg-blue-700 rounded-lg p-1">
                                <button onClick={() => setCurrentDate(new Date(currentDate.setMonth(currentDate.getMonth() - 1)))} className="p-1 hover:bg-blue-600 rounded"><ChevronLeft/></button>
                                <button onClick={() => setCurrentDate(new Date(currentDate.setMonth(currentDate.getMonth() + 1)))} className="p-1 hover:bg-blue-600 rounded"><ChevronRight/></button>
                            </div>
                            <div className="h-8 w-px bg-blue-400 mx-1"></div>
                            <button onClick={() => setShowModal(true)} className="bg-blue-500 hover:bg-blue-400 px-3 py-2 rounded flex items-center gap-2 text-sm font-medium transition">
                                <UserPlus size={18}/> เพิ่มคน
                            </button>
                            <button onClick={exportExcel} className="bg-green-500 hover:bg-green-400 px-4 py-2 rounded flex items-center gap-2 text-sm font-bold shadow transition">
                                <Download size={18}/> Excel
                            </button>
                        </div>
                    </div>

                    {/* Modal */}
                    {showModal && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[100]">
                            <div className="bg-white p-6 rounded-lg shadow-xl w-96">
                                <h3 className="text-lg font-bold mb-4 text-gray-800">เพิ่มพยาบาลใหม่</h3>
                                <div className="space-y-3">
                                    <input className="w-full border p-2 rounded" placeholder="ชื่อ-สกุล" value={newNurseName} onChange={e => setNewNurseName(e.target.value)} autoFocus />
                                </div>
                                <div className="flex justify-end gap-2 mt-6">
                                    <button onClick={() => setShowModal(false)} className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">ยกเลิก</button>
                                    <button onClick={handleAddNurse} className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">บันทึก</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Table */}
                    <div className="flex-1 overflow-auto relative bg-white m-4 shadow-lg rounded border border-gray-200">
                        <table className="border-collapse">
                            <thead>
                                <tr className="h-10 bg-gray-50 text-gray-700 font-semibold text-sm">
                                    <th className="sticky-1">No</th>
                                    <th className="sticky-2">ชื่อ - สกุล</th>
                                    {Array.from({ length: getDaysInMonth() }, (_, i) => {
                                        const day = i + 1;
                                        const isRed = isHoliday(day);
                                        return (
                                            <th 
                                                key={i} 
                                                onClick={() => toggleHoliday(day)}
                                                className={`min-w-[35px] header-hover select-none transition-colors border-b-2 ${isRed ? 'text-red-600 bg-red-50 border-red-200' : 'border-gray-200'}`}
                                                title="คลิกเพื่อตั้งค่าวันหยุด"
                                            >
                                                {day}
                                                <div className="text-[10px] font-normal text-gray-400 mt-[-2px]">
                                                    {['อา','จ','อ','พ','พฤ','ศ','ส'][new Date(currentDate.getFullYear(), currentDate.getMonth(), day).getDay()]}
                                                </div>
                                            </th>
                                        );
                                    })}
                                    <th className="min-w-[60px] bg-gray-100">รวมเวร<br/>บ-ด</th>
                                    <th className="min-w-[60px] bg-gray-100">ค่าเวร</th>
                                    <th className="min-w-[60px] bg-orange-50 text-orange-800">รวม<br/>OT</th>
                                    <th className="min-w-[60px] bg-orange-50 text-orange-800">ค่า<br/>OT</th>
                                    <th className="min-w-[60px] bg-gray-100">วันทำ<br/>การ</th>
                                </tr>
                            </thead>
                            <tbody>
                                {nurses.map((nurse, idx) => {
                                    const s = countStats(nurse.id);
                                    return (
                                        <React.Fragment key={nurse.id}>
                                            {/* Row 1 (Top: OT) */}
                                            <tr className="group hover:bg-gray-50">
                                                <td rowSpan={2} className="sticky-1 font-bold text-gray-500 bg-white group-hover:bg-gray-50">{idx + 1}</td>
                                                <td rowSpan={2} className="sticky-2 text-left px-2 relative bg-white group-hover:bg-gray-50 overflow-hidden" title={nurse.name}>
                                                    <div className="font-medium text-gray-800 text-sm truncate pr-6 w-full">{nurse.name}</div>
                                                    <button onClick={() => handleDeleteNurse(nurse.id)} className="absolute right-1 top-1/2 -translate-y-1/2 text-gray-300 hover:text-red-500 transition-colors p-1"><Trash2 size={14} /></button>
                                                </td>
                                                
                                                {Array.from({ length: getDaysInMonth() }, (_, i) => {
                                                    const d = i + 1;
                                                    const val = schedule[getKey(nurse.id, 0, d)] || '0'; 
                                                    const colorClass = val !== '0' ? 'text-red-600 font-bold bg-red-50' : 'text-gray-300 bg-white';
                                                    return <td key={d} onClick={() => cycleShift(nurse.id, 0, d)} className={`cell-hover border-b-0 ${colorClass}`}>{val}</td>;
                                                })}

                                                <td rowSpan={2} className="bg-gray-100 font-bold text-gray-800">{s.bdCount}</td>
                                                <td rowSpan={2} className="bg-gray-100 text-gray-600 text-xs">{s.bdPay > 0 ? s.bdPay : '-'}</td>
                                                <td rowSpan={2} className="bg-orange-50 font-bold text-orange-800">{s.otCount}</td>
                                                <td rowSpan={2} className="bg-orange-50 text-orange-800 text-xs">{s.otPay > 0 ? s.otPay : '-'}</td>
                                                <td rowSpan={2} className="bg-gray-100 font-bold text-gray-800">{s.workDays}</td>
                                            </tr>

                                            {/* Row 2 (Bottom: Normal) */}
                                            <tr className="group hover:bg-gray-50 border-b-2 border-gray-200">
                                                {Array.from({ length: getDaysInMonth() }, (_, i) => {
                                                    const d = i + 1;
                                                    const val = schedule[getKey(nurse.id, 1, d)] || '0';
                                                    return <td key={d} onClick={() => cycleShift(nurse.id, 1, d)} className={`cell-hover ${SHIFT_TYPES[val]?.color || ''}`}>{val}</td>;
                                                })}
                                            </tr>
                                        </React.Fragment>
                                    );
                                })}
                            </tbody>
                            <tfoot className="bg-gray-100 font-bold text-gray-600 text-xs">
                                <tr>
                                    <td colSpan="2" className="sticky-1 text-right px-2 bg-gray-100 z-50 h-8 border-r-0"></td>
                                    <td className="sticky-2 bg-gray-100 text-right px-2 shadow-none border-r-2 border-gray-300">รวม เช้า</td>
                                    {Array.from({ length: getDaysInMonth() }, (_, i) => <td key={i} className="text-green-600">{countDaily(i+1, 'ช') || '-'}</td>)}
                                    <td colSpan="5" className="bg-gray-200"></td>
                                </tr>
                                <tr>
                                    <td colSpan="2" className="sticky-1 bg-gray-100 border-r-0"></td>
                                    <td className="sticky-2 bg-gray-100 text-right px-2 shadow-none border-r-2 border-gray-300">รวม บ่าย</td>
                                    {Array.from({ length: getDaysInMonth() }, (_, i) => <td key={i} className="text-yellow-600">{countDaily(i+1, 'บ') || '-'}</td>)}
                                    <td colSpan="5" className="bg-gray-200"></td>
                                </tr>
                                <tr>
                                    <td colSpan="2" className="sticky-1 bg-gray-100 border-r-0"></td>
                                    <td className="sticky-2 bg-gray-100 text-right px-2 shadow-none border-r-2 border-gray-300">รวม ดึก</td>
                                    {Array.from({ length: getDaysInMonth() }, (_, i) => <td key={i} className="text-purple-600">{countDaily(i+1, 'ด') || '-'}</td>)}
                                    <td colSpan="5" className="bg-gray-200"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    
                    <div className="bg-white border-t p-2 text-xs flex flex-wrap gap-3 items-center justify-center text-gray-600 shrink-0">
                         <span className="text-gray-500 font-medium">Tip: คลิกหัวตารางวันที่เพื่อตั้งวันหยุด | ชี้ที่ชื่อเพื่อดูชื่อเต็ม</span>
                        <div className="h-4 w-px bg-gray-300 mx-2"></div>
                        <span className="px-2 py-1 rounded border bg-red-50 text-red-600 font-bold">บน=OT</span>
                        <span className="px-2 py-1 rounded border bg-white text-gray-400">0=หยุด</span>
                        {CYCLE_BOTTOM.filter(s => s !== '0').map(s => (
                            <span key={s} className={`px-2 py-1 rounded border ${SHIFT_TYPES[s].color}`}>
                                {s}
                            </span>
                        ))}
                    </div>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<RosterApp />);
    </script>
</body>
</html>
